<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LoR Package — Portfolio</title>
  <link rel="stylesheet" href="style.css">
  <meta name="description" content="LoR package details with notes, cards, and reflection.">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a href="project.html?slug=lor-cards" class="back-link js-back" aria-label="Back to LoR overview">← Back</a>
      <h1 class="brand small">
        <svg class="pacman" viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="48" fill="currentColor"></circle>
          <polygon points="50,50 100,25 100,75" fill="var(--bg)"></polygon>
        </svg>
        <span>hristoph Maureder</span>
      </h1>
    </div>
  </header>

  <main class="container" id="pkg-content" aria-live="polite">
    <p class="muted">Loading package…</p>
  </main>

  <section class="contact-cta" aria-labelledby="contact-title">
    <div class="container">
      <h2 id="contact-title">Want to know more? Let’s chat!</h2>
      <div class="cta-row">
        <a class="btn" href="https://www.linkedin.com/in/christoph-maureder" target="_blank" rel="noopener">LinkedIn</a>
        <a class="btn js-copy-email" href="#" data-email="maureder.christoph@gmail.com">Email me</a>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container"><p>© <span id="year"></span> Christoph Maureder</p></div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    function getParam(name) { const p = new URLSearchParams(location.search); return p.get(name); }
    async function loadProjects() { const res = await fetch('projects.json'); if (!res.ok) throw new Error('Failed to load projects.json'); return await res.json(); }

    function wireSoftBack(){
      const back = document.querySelector('.js-back');
      if (!back) return;
      back.addEventListener('click', (e) => {
        e.preventDefault();
        if (history.length > 1) history.back();
        else window.location.href = back.getAttribute('href');
      });
    }

    (function initLightbox(){
      if (window.__LIGHTBOX__) return;
      const overlay = document.createElement('div');
      overlay.id = 'lightbox';
      overlay.className = 'lightbox';
      overlay.setAttribute('aria-hidden','true');
      overlay.innerHTML = `
        <button class="nav prev" aria-label="Previous">‹</button>
        <img class="lightbox-img" alt="Image">
        <button class="nav next" aria-label="Next">›</button>
      `;
      document.body.appendChild(overlay);
      const state = { overlay, imgEl: overlay.querySelector('.lightbox-img'), index: 0, imgs: [] };
      function openAt(imgs, i){ state.imgs = imgs; state.index = (i + imgs.length) % imgs.length;
        state.imgEl.src = state.imgs[state.index].src; overlay.classList.add('is-open'); overlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
      function closeBox(){ overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
      function prev(){ if (state.imgs.length) openAt(state.imgs, state.index - 1); }
      function next(){ if (state.imgs.length) openAt(state.imgs, state.index + 1); }
      overlay.addEventListener('click', (e) => {
        if (e.target.classList.contains('prev')) { prev(); return; }
        if (e.target.classList.contains('next')) { next(); return; }
        if (e.target === overlay) { closeBox(); return; }
      });
      document.addEventListener('keydown', (e) => {
        if (!overlay.classList.contains('is-open')) return;
        if (e.key === 'Escape') closeBox();
        if (e.key === 'ArrowLeft') prev();
        if (e.key === 'ArrowRight') next();
      });
      window.__LIGHTBOX__ = { openAt };
    })();

    function setupLightboxFor(container){
      const imgs = Array.from(container.querySelectorAll('img'));
      if (!imgs.length) return;
      container.addEventListener('click', (e) => {
        const el = e.target.closest('img');
        if (!el) return;
        const idx = imgs.indexOf(el);
        if (idx >= 0 && window.__LIGHTBOX__) window.__LIGHTBOX__.openAt(imgs, idx);
      });
    }

    function renderPkgReflection(pkg) {
      if (!pkg || !pkg.reflection) return null;
      const host = document.createElement('section');
      host.className = 'project-reflection';
      host.id = 'pkg-reflection';

      const ref = pkg.reflection;
      const heading = (pkg.reflectionTitle && String(pkg.reflectionTitle)) ||
                      (ref && typeof ref.heading === 'string' && ref.heading) ||
                      (ref && typeof ref.title === 'string' && ref.title) ||
                      'Reflection';

      const h2 = document.createElement('h2'); h2.textContent = heading; host.appendChild(h2);

      const blocks = Array.isArray(ref) ? ref : (Array.isArray(ref.blocks) ? ref.blocks : null);
      const root = host;

      if (blocks) {
        blocks.forEach(b => {
          if (b.title) { const h = document.createElement('h3'); h.textContent = b.title; root.appendChild(h); }
          if (b.text) {
            b.text.split('\n').forEach(par => {
              if (!par.trim()) return;
              const p = document.createElement('p'); p.textContent = par; root.appendChild(p);
            });
          }
          if (Array.isArray(b.bullets) && b.bullets.length) {
            const ul = document.createElement('ul'); ul.className = 'bullets';
            b.bullets.forEach(t => { const li = document.createElement('li'); li.textContent = t; ul.appendChild(li); });
            root.appendChild(ul);
          }
          if (b.image) {
            const img = document.createElement('img');
            img.src = b.image; img.alt = b.title ? (b.title + ' image') : 'reflection image'; img.loading = 'lazy';
            const wrap = document.createElement('div'); wrap.className = 'gallery'; wrap.appendChild(img);
            root.appendChild(wrap);
          }
          if (Array.isArray(b.images) && b.images.length) {
            const gal = document.createElement('div'); gal.className = 'gallery';
            b.images.forEach(src => { const img = document.createElement('img'); img.src = src; img.loading='lazy'; img.alt = (b.title||'reflection') + ' image'; gal.appendChild(img); });
            root.appendChild(gal);
          }
        });
      } else {
        if (ref.text) ref.text.split('\n').forEach(par => { const pEl = document.createElement('p'); pEl.textContent = par; root.appendChild(pEl); });
        if (Array.isArray(ref.images) && ref.images.length) {
          const gal = document.createElement('div'); gal.className = 'gallery';
          ref.images.forEach(src => { const img = document.createElement('img'); img.src = src; img.loading='lazy'; img.alt = 'reflection image'; gal.appendChild(img); });
          root.appendChild(gal);
        }
      }
      return host;
    }

    (async function init() {
      try {
        const projSlug = decodeURIComponent((getParam('project') || '').trim());
        const pkgSlug  = decodeURIComponent((getParam('pkg') || '').trim());
        const projects = await loadProjects();
        const proj = projects.find(p => p.slug === projSlug);
        if (!proj || !Array.isArray(proj.lorPackages)) { document.getElementById('pkg-content').innerHTML = '<p>Package not found. <a href="index.html">Back to overview</a></p>'; return; }
        const pkg = proj.lorPackages.find(x => x.slug === pkgSlug) || proj.lorPackages[0];
        if (!pkg) { document.getElementById('pkg-content').innerHTML = '<p>Package not found. <a href="index.html">Back to overview</a></p>'; return; }

        document.title = pkg.title + ' — LoR Package';

        const root = document.getElementById('pkg-content');
        root.innerHTML = `
          <article class="project">
            <header class="project-hero">
              <img class="hero" src="${pkg.coverImage || 'assets/placeholder.svg'}" alt="${pkg.title} cover">
              <div class="hero-text">
                <h1>${pkg.title}</h1>
                ${pkg.subtitle ? `<p class="tagline">${pkg.subtitle}</p>` : ''}
                <div class="tags">${(pkg.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}</div>
              </div>
            </header>

            <section class="project-body is-lor">
              <div class="project-content">
                ${pkg.notes ? pkg.notes.split('\n').map(par => `<p>${par}</p>`).join('') :
                   (pkg.overview ? `<p>${pkg.overview}</p>` : '<p></p>')}

                <h2>Cards</h2>
                <div class="card-list" id="card-list"></div>
              </div>
            </section>
          </article>
        `;

        const list = document.getElementById('card-list');
        (pkg.cards || []).forEach(c => {
          const panel = document.createElement('article');
          panel.className = 'card card-vertical';
          panel.innerHTML = `
            <div class="thumb">
              <img loading="lazy" src="${c.image || 'assets/placeholder.svg'}" alt="${c.name || 'Card'}">
            </div>
          `;
          list.appendChild(panel);
        });

        const reflection = renderPkgReflection(pkg);
        if (reflection) root.querySelector('article.project').appendChild(reflection);

        setupLightboxFor(list);
        document.querySelectorAll('.project-reflection .gallery').forEach(setupLightboxFor);

        document.querySelectorAll('.js-back').forEach(b=>b.addEventListener('click',e=>{e.preventDefault(); if(history.length>1){history.back();} else {window.location.href=b.getAttribute('href');}}));
      } catch (err) {
        console.error(err);
        document.getElementById('pkg-content').innerHTML = '<p>Could not load package.</p>';
      }
    })();
  </script>
</body>
</html>
